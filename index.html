<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TTS Calendar — Mobile</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root{
  --dp-blue:#004c97; --dp-blue-2:#0f5fb3; --bg:#f4f6f8; --ink:#14213d;
  --chip:#eaf2fb; --chip-ink:#0d3b66; --ring:#dae7f5;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:16px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--dp-blue),var(--dp-blue-2));color:#fff;padding:10px 12px;box-shadow:0 2px 10px rgba(0,0,0,.12)}
.bar{display:flex;gap:8px;align-items:center}
.search{flex:1}
.search input{width:100%;height:44px;padding:0 14px;border:none;border-radius:12px;outline:none;font-size:17px;background:#fff;color:#111;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}
.filterBtn{height:44px;background:#fff;color:var(--dp-blue);border:none;border-radius:12px;padding:0 14px;font-weight:700}
.panel{background:#fff;margin:10px 12px;border-radius:16px;padding:12px;box-shadow:0 1px 0 #e9eef6}
.grid{display:grid;gap:10px}
.lbl{display:block;font-size:12px;color:#5b6b82;margin:6px 2px}
.sel, .reset{width:100%;padding:12px;border:1px solid var(--ring);border-radius:12px;background:#fff;font-size:16px}
.reset{background:#f1f5fb;font-weight:600}
.hidden{display:none!important}
.count{padding:6px 14px 0;font-size:14px;color:#334;opacity:.85}
.list{display:grid;gap:12px;padding:10px 12px 40px}
.card{background:#fff;border-radius:18px;padding:12px 14px;box-shadow:0 1px 0 #e9eef6;border:1px solid #eef3f9}
.row{display:flex;gap:10px;flex-wrap:wrap}
.badge{background:var(--chip);color:var(--chip-ink);padding:8px 10px;border-radius:12px;font-size:14px}
h3{margin:8px 0 6px;font-size:20px;line-height:1.2}
.small{color:#5b6b82;font-size:15px}
footer{height:40px}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const PASS_KEY='tts_pass_ok';
document.addEventListener('DOMContentLoaded',()=>{
  if(localStorage.getItem(PASS_KEY)!=='1'){
    const p=prompt('Enter passcode:');
    if(p!=='AdlertheInnovator'){document.body.innerHTML='<div style="padding:24px">Reload to try again.</div>';return;}
    localStorage.setItem(PASS_KEY,'1');
  }
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }
});
</script>
</head>
<body>
<header class="header">
  <div class="bar">
    <form class="search" role="search" onsubmit="event.preventDefault();">
      <input id="q" type="search" placeholder="Search names, titles, rooms…" aria-label="Search">
    </form>
    <button id="toggle" class="filterBtn" type="button" aria-expanded="false">Filters ▾</button>
  </div>
</header>

<section id="filters" class="panel hidden" aria-label="Filters">
  <div class="grid">
    <div>
      <label class="lbl" for="cohort">Cohort</label>
      <select id="cohort" class="sel">
        <option value="">All</option>
        <option>BFA1</option><option>BFA2</option><option>BFA3</option><option>BFA4</option>
        <option>MFA1</option><option>MFA2</option>
      </select>
    </div>
    <div>
      <label class="lbl" for="category">Category</label>
      <select id="category" class="sel">
        <option value="">All</option>
      </select>
    </div>
    <div>
      <label class="lbl" for="instructor">Instructor</label>
      <select id="instructor" class="sel">
        <option value="">All</option>
      </select>
    </div>
    <button class="reset" id="reset" type="button">Reset filters</button>
  </div>
</section>

<div class="count" id="count">Loading…</div>
<section class="list" id="list"></section>
<footer></footer>

<script>
const $=s=>document.querySelector(s);
const list=$('#list'); const count=$('#count');
const q=$('#q'); const selCohort=$('#cohort'); const selCat=$('#category'); const selInstr=$('#instructor');
let ROSTERS={}; let EVENTS=[];

function populateSelect(el, items){
  el.innerHTML=''; const f = document.createDocumentFragment();
  const optAll = document.createElement('option'); optAll.value=''; optAll.textContent='All'; f.appendChild(optAll);
  items.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; f.appendChild(o); });
  el.appendChild(f);
}
function uniq(xs){ return [...new Set(xs.filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }

function normalizeTime(t){ return (t||'').trim(); }
function normalizeDate(d){ try{ return new Date(d).toISOString().slice(0,10); }catch(e){ return d; } }

function buildFiltersFromData(rows){
  const cats = uniq(rows.map(r=>r.category||''));
  const ins  = uniq(rows.map(r=>r.instructor||''));
  populateSelect(selCat, cats);
  populateSelect(selInstr, ins);
}

function matchRow(r, f){
  if(f.cohort && !(r.cohorts||[]).includes(f.cohort)) return false;
  if(f.cat && (r.category||'')!==f.cat) return false;
  if(f.instr && (r.instructor||'')!==f.instr) return false;
  if(f.q){
    const hay = [r.title,r.location,r.category,r.instructor,(r.cohorts||[]).join(' '),(r.notes||'')].join(' ').toLowerCase();
    const toks = f.q.split(/\s+/).filter(Boolean);
    for(const t of toks){ if(!hay.includes(t)) return false; }
  }
  return true;
}

function fmtDate(iso){ const d=new Date(iso+'T00:00:00'); return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric',year:'numeric'}); }
function fmtTime(s,e){ if(!s) return ''; const ds=new Date('1970-01-01T'+s); const de=e? new Date('1970-01-01T'+e):null; const a=ds.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'}); return e? a+'—'+de.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'}):a; }

function render(){
  const f = { q:q.value.trim().toLowerCase(), cohort:selCohort.value, cat:selCat.value, instr:selInstr.value };
  const rows = EVENTS.filter(r=>matchRow(r,f)).sort((a,b)=> (a.date||'').localeCompare(b.date) || (a.start||'').localeCompare(b.start));
  count.textContent = `Showing ${rows.length} of ${EVENTS.length} event(s)`;
  list.innerHTML = rows.map(r=>`<article class="card">
    <div class="row">
      <span class="badge">${fmtDate(r.date||'')}</span>
      <span class="badge">${fmtTime(r.start,r.end)}</span>
    </div>
    <div class="row" style="margin-top:6px">
      ${r.location? `<span class="badge">${r.location}</span>`:''}
      ${r.category? `<span class="badge">${r.category}</span>`:''}
      ${(r.cohorts||[]).map(c=>`<span class="badge">${c}</span>`).join('')}
      ${r.instructor? `<span class="badge">${r.instructor}</span>`:''}
    </div>
    <h3>${r.title||''}</h3>
    ${r.notes? `<div class="small">${r.notes}</div>`:''}
  </article>`).join('');
}

['input','change'].forEach(evt=>{ q.addEventListener(evt,render); selCohort.addEventListener(evt,render); selCat.addEventListener(evt,render); selInstr.addEventListener(evt,render); });
const panel=$('#filters'); const toggle=$('#toggle'); toggle.addEventListener('click',()=>{ const show = panel.classList.toggle('hidden')?'false':'true'; toggle.setAttribute('aria-expanded',show); });

function loadAll(){
  fetch('rosters.json').then(r=>r.json()).then(j=>{ ROSTERS=j||{}; }).catch(()=>{});
  Papa.parse('events.csv', {
    download:true, header:true, skipEmptyLines:true,
    complete: (res)=>{
      EVENTS = res.data.map(r => ({
        date: (r.date||'').slice(0,10),
        start: normalizeTime(r.start||''),
        end: normalizeTime(r.end||''),
        title: r.title||'',
        category: r.category||'',
        location: r.location||'',
        cohorts: (r.cohorts||'').split(/[|,\s]+/).map(s=>s.trim()).filter(Boolean),
        instructor: r.instructor||'',
        notes: r.notes||''
      }));
      buildFiltersFromData(EVENTS);
      render();
    },
    error: (err)=>{ count.textContent='Could not load events.csv'; console.error(err); }
  });
}
document.addEventListener('DOMContentLoaded', loadAll);
</script>
</body>
</html>